<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="description" content="a blog by a guy who likes emacs"/><meta property="og:image" content="/blog/images/jared-engler-blog.png"/><meta name="og:title" content="jared.engler.blog"/><meta name="twitter:card" content="summary_large_image"/><title>next.js: workflow with github pages and actions</title><meta name="next-head-count" content="7"/><link rel="preload" href="/blog/_next/static/css/dfd64abbb58af9f5d7f8.css" as="style"/><link rel="stylesheet" href="/blog/_next/static/css/dfd64abbb58af9f5d7f8.css" data-n-g=""/><link rel="preload" href="/blog/_next/static/css/9eb0ab91ec5bd9812a2e.css" as="style"/><link rel="stylesheet" href="/blog/_next/static/css/9eb0ab91ec5bd9812a2e.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/blog/_next/static/chunks/main-f094e29a130fd0913879.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/commons.4e446db3eadf18dc2ad0.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/pages/_app-70651e13387bad6b3f4b.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.d4a3db8613b49501ab76.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/pages/posts/%5Bid%5D-248d96d842634965509c.js" as="script"/></head><body><div id="__next"><div class="layout_container__2t4v2"><header class="layout_header__2rhWq"><a href="/blog"><img src="/blog/images/me-centered-better.png" class="layout_headerImage__2h5On utils_borderCircle__13qdJ" alt="jared.engler"/></a><h2 class="utils_headingLg__de7p0"><a class="utils_colorInherit__3Gudf" href="/blog">jared.engler</a></h2></header><main><article><h1 class="utils_headingXl__1XecN">next.js: workflow with github pages and actions</h1><div class="utils_lightText__12Ckm"><time dateTime="2020-12-22">December 22, 2020</time></div><div class="utils_content__zjeg5"><p>hey y'all! as you may or may not know, github has a service called pages, which allows you to host static files for free. this post will go over how to setup a continuous integration workflow to deploy a blog to pages.</p>
<h1>terms</h1>
<ul>
<li>
<p><strong><a href="https://pages.github.com">github pages</a></strong></p>
<ul>
<li>a service that allows you to pick a particular branch and subdirectory of a git repository to use as a static hosting directory. it is a very handy service for creating small single page apps which run entirely on the browser.</li>
</ul>
</li>
<li>
<p><strong><a href="https://nextjs.org">next.js</a></strong></p>
<ul>
<li>a jam stack implementation based off react which provides many goodies for single-page front-end applications. i picked it because of it's ability to render markdown easily with a lightweight setup. this tutorial wont go too deep into next.js (as i admittedly don't know that much) and will only show what is necessary to get a next.js app working on github pages.</li>
</ul>
</li>
<li>
<p><strong><a href="https://github.com/features/actions">github actions</a></strong></p>
<ul>
<li>introduced in nov 2019, it allows you to program automated workflows based on events that happen within your git repository. these workflows are concisely defined within yaml files which is added to your repository. we will see an example of one of these such yamls.</li>
</ul>
</li>
</ul>
<h1>setting up the repo</h1>
<p>in order to get a starter next.js app you can follow <a href="https://nextjs.org/learn/basics/create-nextjs-app">this guide</a>. this will give you a good introduction to next.js and its capabilities, as well as provide you with something to deploy. i will be using a site that has been filled out by following this guide up through the <em>dynamic routes</em> section, yet the steps will be the same for any next.js app.</p>
<p>once you have gone through this tutorial you should be left with a git repo containing your new app. also, if you haven't already, make sure to setup your github account with ssh key access by following the guide <a href="https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/connecting-to-github-with-ssh">here</a>. this will help smooth out the authentication step when pushing your git repo so you don't have to type your password every time. in order to push my blog i executed the following commands:</p>
<pre><code class="language-bash">$ git remote add origin git@github.com:lagooned/blog.git
$ git push origin HEAD
</code></pre>
<p>this will push code to the default branch on your repository. when visiting <a href="https://github.com/lagooned/blog">the repository</a> on github, you should see your entire root directory and the readme rendered.</p>
<h1>creating the workflow</h1>
<p>great, now we've pushed the code to our repository, we need to setup a workflow which will deploy it. we do this by creating a workflow yaml file. these are placed under the root directory of the repository in the .github/workflow directory. you can create this file like so:</p>
<pre><code class="language-bash">$ touch .github/workflows/node.js.yaml
</code></pre>
<p>this file is called <em>node.js.yaml</em> because the build tool we will be using is npm (node package manager), which hopefully you have some experience with by now after the next.js tutorial. </p>
<p><a href="https://github.com/lagooned/blog/blob/main/.github/workflows/node.js.yml">here</a> is the contents of the workflow. this file defines upon a push to a particular branch, in this case <strong>main</strong>, execute this workflow. in looking closer at the yaml, this workflow is a build process which executes on the latest version of ubuntu (hence ubuntu-latest), and requires the latest version of node.js 12 (hence 12.x). this workflow also is comprised of many jobs which run in order. in looking at the <strong>steps</strong> section of the configuration, we find these steps:</p>
<pre><code class="language-yaml">steps:
- name: checkout
...
- name: require node ${{ matrix.node-version }}
...
- name: install deps
...
- name: build static pages
...
- name: deploy to gh-pages
...
</code></pre>
<p>these are the main steps of our workflow. first we checkout our repo from github; then pull in our build tool runtime, <strong>node.js</strong>, as well as our build tool, <strong>npm</strong>; subsequently install the dependencies defined with in our project manifest (aka the package.json and package-lock.json); export our next.js app to a bundle of static resources; and finally deploy our static resources to github pages.</p>
<p>the final step requires the setup of a <a href="https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token">personal access token</a> with the following permissions:</p>
<ul>
<li>repo:status</li>
<li>repo_deployment</li>
<li>public_repo</li>
<li>repo:invite</li>
</ul>
<p>add this token's value to your repository as a secret with the id <strong>ACTIONS_DEPLOY_ACCESS_TOKEN</strong> (as referred in the yaml via the *secrets.** namespace). this token will allow the workflow to push to the gh-pages branch of your repository.</p>
<p>add this yaml to your repository and commit:</p>
<pre><code class="language-bash">$ git add .github/workflow/node.js.yaml
$ git commit -m "added node.js.yaml actions workflow"
</code></pre>
<h1>configure base path</h1>
<p>when deploying to github pages, there is a few major caveats, the first being the implicit url path segmented added to the url which matches the repo name. for example, if i created the repository
<a href="https://github.com/lagooned/blog">https://github.com/lagooned/blog</a> the cooresponding pages host url will become <a href="https://lagooned.github.io/blog">https://lagooned.github.io/blog</a>. this <strong>/blog</strong> on the end of the domain creates an issue, as the static generated files will miss this very necessary path segment, thus causing 404's when attempting to load static assets.</p>
<p>to fix this, create a file called <em>next.config.js</em> under the root directory of your project with something along the lines of the following contents:</p>
<pre><code class="language-javascript">module.exports = {
  basePath: '/blog'
}
</code></pre>
<p>make sure this value matches your repo name, and perspective base path segment. don't forget to commit!</p>
<pre><code class="language-bash">$ git add next.config.js
$ git commit -m "added basepath configuration via next.config.js"
</code></pre>
<h1>setup npm tasks</h1>
<p>npm tasks are very useful for automating common tasks for your repo. the definitions for these tasks reside in the <strong>scripts</strong> section of the package.json. modify the <em>build</em> task and add the following task called <em>deploy</em> to your package.json so that it looks like so:</p>
<pre><code class="language-json">...
"scripts": {
  "dev": "next dev",
  "build": "next build &#x26;&#x26; next export -o build",
  "start": "next start",
  "deploy": "touch build/.nojekyll &#x26;&#x26; gh-pages -d build -t true"
},
...
</code></pre>
<p>this modification to the <strong>build</strong> task will include an instrumental step- to generate the static files to deploy to pages, and place the output in a directory called <em>build</em>. in addition, the new <strong>deploy</strong> task will create an empty file called .nojekyll in the newly created build directory and deploy using the gh-pages npm package.</p>
<p>there are a few things to unpack here. the .nojekyll file is to circumvent a pretty big quirk of github pages. <a href="https://jekyllrb.com">jekyll</a> is a ruby-based, markdown blog generation platform, kinda similar to the one we're currently making. it does a similar process of generating static files, however, it uses special files which start with underscores. github pages natively supports interpreting these files, and this support conflicts with next.js' default static file <em>_next</em> directory. adding this .nojekyll file will disable this additional processing and allow our static assets to be retrieved without any issues.</p>
<p>finally, commit and push:</p>
<pre><code class="language-bash">$ git add package.json
$ git commit -m "modified build and added deploy tasks"
$ git push origin HEAD
</code></pre>
<h1>conclusion</h1>
<p>visit your repo, click the actions tab, and watch your workflow start and run to completion. this will create a branch on your repository called 'gh-pages' which will contain your newly-generated static assets.</p>
<p>visit your pages url and enjoy your app, lmk via email if you have any trouble. :)</p>
<p>-jared</p>
</div></article></main><div class="layout_backToHome__1vZsp"><a href="/blog">‚Üê Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"hosting-next-js-site-github-pages","contentHtml":"\u003cp\u003ehey y'all! as you may or may not know, github has a service called pages, which allows you to host static files for free. this post will go over how to setup a continuous integration workflow to deploy a blog to pages.\u003c/p\u003e\n\u003ch1\u003eterms\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e\u003ca href=\"https://pages.github.com\"\u003egithub pages\u003c/a\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ea service that allows you to pick a particular branch and subdirectory of a git repository to use as a static hosting directory. it is a very handy service for creating small single page apps which run entirely on the browser.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e\u003ca href=\"https://nextjs.org\"\u003enext.js\u003c/a\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ea jam stack implementation based off react which provides many goodies for single-page front-end applications. i picked it because of it's ability to render markdown easily with a lightweight setup. this tutorial wont go too deep into next.js (as i admittedly don't know that much) and will only show what is necessary to get a next.js app working on github pages.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003e\u003ca href=\"https://github.com/features/actions\"\u003egithub actions\u003c/a\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eintroduced in nov 2019, it allows you to program automated workflows based on events that happen within your git repository. these workflows are concisely defined within yaml files which is added to your repository. we will see an example of one of these such yamls.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003esetting up the repo\u003c/h1\u003e\n\u003cp\u003ein order to get a starter next.js app you can follow \u003ca href=\"https://nextjs.org/learn/basics/create-nextjs-app\"\u003ethis guide\u003c/a\u003e. this will give you a good introduction to next.js and its capabilities, as well as provide you with something to deploy. i will be using a site that has been filled out by following this guide up through the \u003cem\u003edynamic routes\u003c/em\u003e section, yet the steps will be the same for any next.js app.\u003c/p\u003e\n\u003cp\u003eonce you have gone through this tutorial you should be left with a git repo containing your new app. also, if you haven't already, make sure to setup your github account with ssh key access by following the guide \u003ca href=\"https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/connecting-to-github-with-ssh\"\u003ehere\u003c/a\u003e. this will help smooth out the authentication step when pushing your git repo so you don't have to type your password every time. in order to push my blog i executed the following commands:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e$ git remote add origin git@github.com:lagooned/blog.git\n$ git push origin HEAD\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ethis will push code to the default branch on your repository. when visiting \u003ca href=\"https://github.com/lagooned/blog\"\u003ethe repository\u003c/a\u003e on github, you should see your entire root directory and the readme rendered.\u003c/p\u003e\n\u003ch1\u003ecreating the workflow\u003c/h1\u003e\n\u003cp\u003egreat, now we've pushed the code to our repository, we need to setup a workflow which will deploy it. we do this by creating a workflow yaml file. these are placed under the root directory of the repository in the .github/workflow directory. you can create this file like so:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e$ touch .github/workflows/node.js.yaml\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ethis file is called \u003cem\u003enode.js.yaml\u003c/em\u003e because the build tool we will be using is npm (node package manager), which hopefully you have some experience with by now after the next.js tutorial. \u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/lagooned/blog/blob/main/.github/workflows/node.js.yml\"\u003ehere\u003c/a\u003e is the contents of the workflow. this file defines upon a push to a particular branch, in this case \u003cstrong\u003emain\u003c/strong\u003e, execute this workflow. in looking closer at the yaml, this workflow is a build process which executes on the latest version of ubuntu (hence ubuntu-latest), and requires the latest version of node.js 12 (hence 12.x). this workflow also is comprised of many jobs which run in order. in looking at the \u003cstrong\u003esteps\u003c/strong\u003e section of the configuration, we find these steps:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-yaml\"\u003esteps:\n- name: checkout\n...\n- name: require node ${{ matrix.node-version }}\n...\n- name: install deps\n...\n- name: build static pages\n...\n- name: deploy to gh-pages\n...\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ethese are the main steps of our workflow. first we checkout our repo from github; then pull in our build tool runtime, \u003cstrong\u003enode.js\u003c/strong\u003e, as well as our build tool, \u003cstrong\u003enpm\u003c/strong\u003e; subsequently install the dependencies defined with in our project manifest (aka the package.json and package-lock.json); export our next.js app to a bundle of static resources; and finally deploy our static resources to github pages.\u003c/p\u003e\n\u003cp\u003ethe final step requires the setup of a \u003ca href=\"https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token\"\u003epersonal access token\u003c/a\u003e with the following permissions:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003erepo:status\u003c/li\u003e\n\u003cli\u003erepo_deployment\u003c/li\u003e\n\u003cli\u003epublic_repo\u003c/li\u003e\n\u003cli\u003erepo:invite\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eadd this token's value to your repository as a secret with the id \u003cstrong\u003eACTIONS_DEPLOY_ACCESS_TOKEN\u003c/strong\u003e (as referred in the yaml via the *secrets.** namespace). this token will allow the workflow to push to the gh-pages branch of your repository.\u003c/p\u003e\n\u003cp\u003eadd this yaml to your repository and commit:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e$ git add .github/workflow/node.js.yaml\n$ git commit -m \"added node.js.yaml actions workflow\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003econfigure base path\u003c/h1\u003e\n\u003cp\u003ewhen deploying to github pages, there is a few major caveats, the first being the implicit url path segmented added to the url which matches the repo name. for example, if i created the repository\n\u003ca href=\"https://github.com/lagooned/blog\"\u003ehttps://github.com/lagooned/blog\u003c/a\u003e the cooresponding pages host url will become \u003ca href=\"https://lagooned.github.io/blog\"\u003ehttps://lagooned.github.io/blog\u003c/a\u003e. this \u003cstrong\u003e/blog\u003c/strong\u003e on the end of the domain creates an issue, as the static generated files will miss this very necessary path segment, thus causing 404's when attempting to load static assets.\u003c/p\u003e\n\u003cp\u003eto fix this, create a file called \u003cem\u003enext.config.js\u003c/em\u003e under the root directory of your project with something along the lines of the following contents:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003emodule.exports = {\n  basePath: '/blog'\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003emake sure this value matches your repo name, and perspective base path segment. don't forget to commit!\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e$ git add next.config.js\n$ git commit -m \"added basepath configuration via next.config.js\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003esetup npm tasks\u003c/h1\u003e\n\u003cp\u003enpm tasks are very useful for automating common tasks for your repo. the definitions for these tasks reside in the \u003cstrong\u003escripts\u003c/strong\u003e section of the package.json. modify the \u003cem\u003ebuild\u003c/em\u003e task and add the following task called \u003cem\u003edeploy\u003c/em\u003e to your package.json so that it looks like so:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-json\"\u003e...\n\"scripts\": {\n  \"dev\": \"next dev\",\n  \"build\": \"next build \u0026#x26;\u0026#x26; next export -o build\",\n  \"start\": \"next start\",\n  \"deploy\": \"touch build/.nojekyll \u0026#x26;\u0026#x26; gh-pages -d build -t true\"\n},\n...\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ethis modification to the \u003cstrong\u003ebuild\u003c/strong\u003e task will include an instrumental step- to generate the static files to deploy to pages, and place the output in a directory called \u003cem\u003ebuild\u003c/em\u003e. in addition, the new \u003cstrong\u003edeploy\u003c/strong\u003e task will create an empty file called .nojekyll in the newly created build directory and deploy using the gh-pages npm package.\u003c/p\u003e\n\u003cp\u003ethere are a few things to unpack here. the .nojekyll file is to circumvent a pretty big quirk of github pages. \u003ca href=\"https://jekyllrb.com\"\u003ejekyll\u003c/a\u003e is a ruby-based, markdown blog generation platform, kinda similar to the one we're currently making. it does a similar process of generating static files, however, it uses special files which start with underscores. github pages natively supports interpreting these files, and this support conflicts with next.js' default static file \u003cem\u003e_next\u003c/em\u003e directory. adding this .nojekyll file will disable this additional processing and allow our static assets to be retrieved without any issues.\u003c/p\u003e\n\u003cp\u003efinally, commit and push:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003e$ git add package.json\n$ git commit -m \"modified build and added deploy tasks\"\n$ git push origin HEAD\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1\u003econclusion\u003c/h1\u003e\n\u003cp\u003evisit your repo, click the actions tab, and watch your workflow start and run to completion. this will create a branch on your repository called 'gh-pages' which will contain your newly-generated static assets.\u003c/p\u003e\n\u003cp\u003evisit your pages url and enjoy your app, lmk via email if you have any trouble. :)\u003c/p\u003e\n\u003cp\u003e-jared\u003c/p\u003e\n","title":"next.js: workflow with github pages and actions","date":"2020-12-22"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"hosting-next-js-site-github-pages"},"buildId":"lEhFCEQ4-MzQ14aBNBAua","assetPrefix":"/blog","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/blog/_next/static/chunks/polyfills-86038f8325ecf14c2308.js"></script><script src="/blog/_next/static/chunks/main-f094e29a130fd0913879.js" async=""></script><script src="/blog/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/blog/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" async=""></script><script src="/blog/_next/static/chunks/commons.4e446db3eadf18dc2ad0.js" async=""></script><script src="/blog/_next/static/chunks/pages/_app-70651e13387bad6b3f4b.js" async=""></script><script src="/blog/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.d4a3db8613b49501ab76.js" async=""></script><script src="/blog/_next/static/chunks/pages/posts/%5Bid%5D-248d96d842634965509c.js" async=""></script><script src="/blog/_next/static/lEhFCEQ4-MzQ14aBNBAua/_buildManifest.js" async=""></script><script src="/blog/_next/static/lEhFCEQ4-MzQ14aBNBAua/_ssgManifest.js" async=""></script></body></html>